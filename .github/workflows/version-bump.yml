- name: Update module versions
  run: |
    set -euo pipefail

    increment_version() {
      local version="$1"
      local mode="$2"
      local base="${version%%-*}"
      local suffix=""
      [[ "$version" == *"-"* ]] && suffix="-${version#*-}"
      IFS='.' read -r major minor patch <<< "$base"
      major="${major:-0}"; minor="${minor:-0}"; patch="${patch:-0}"
      if [[ "$mode" == "patch" ]]; then
        patch=$((patch + 1))
      else
        minor=$((minor + 1)); patch=0
      fi
      echo "${major}.${minor}.${patch}${suffix}"
    }

    META_FILE="$VERSION_META_FILE"
    mapfile -t modules < <(jq -r '.modules | keys[]' "$META_FILE")

    has_explicit_version() {
      local pom="$1"
      # remove <parent>...</parent> block, then check for <version>...</version>
      perl -0777 -pe 's|<parent>.*?</parent>||sg' "$pom" | grep -q "<version>"
    }

    for name in "${modules[@]}"; do
      path=$(jq -r ".modules[\"$name\"].path" "$META_FILE")
      current=$(jq -r ".modules[\"$name\"].current" "$META_FILE")
      changed=$(jq -r ".modules[\"$name\"].changed" "$META_FILE")

      pom="$path/pom.xml"
      if ! has_explicit_version "$pom"; then
        echo "Skipping $name ($path): version is inherited from parent (it will follow root)."
        continue
      fi

      if [[ "$changed" == "true" ]]; then
        next=$(increment_version "$current" "$BUMP_KIND")
      else
        next="$current"
      fi

      echo "Setting $name ($path) version -> $next (changed=$changed)"
      mvn -B -f "$pom" versions:set -DnewVersion="$next" -DgenerateBackupPoms=false
    done
